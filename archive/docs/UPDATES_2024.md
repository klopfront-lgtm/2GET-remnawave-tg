# –û–±–Ω–æ–≤–ª–µ–Ω–∏—è 2024 / Updates 2024

## üá∑üá∫ –†—É—Å—Å–∫–∞—è –≤–µ—Ä—Å–∏—è

### –†–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–í –ø—Ä–æ–µ–∫—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞–º–∏, –±–∞–ª–∞–Ω—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Å–∫–∏–¥–∫–∞–º–∏. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Alembic.

#### –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–æ–≤–æ–≤–≤–µ–¥–µ–Ω–∏—è:
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–∫–∏–¥–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (—Å–∫–∏–¥–∫–∏, –±–∞–ª–∞–Ω—Å, –±–æ–Ω—É—Å–Ω—ã–µ –¥–Ω–∏)
- ‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- ‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞–º–∏
- ‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∞–º–∏
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Alembic

#### –°–ø–∏—Å–æ–∫ –Ω–æ–≤—ã—Ö –∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:

**–ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- [`db/migrations/versions/001_add_tariffs_balance_discounts.py`](db/migrations/versions/001_add_tariffs_balance_discounts.py) ‚ú® –ù–û–í–´–ô
- [`db/migrations/env.py`](db/migrations/env.py) ‚ú® –ù–û–í–´–ô
- [`db/migrations/script.py.mako`](db/migrations/script.py.mako) ‚ú® –ù–û–í–´–ô
- [`alembic.ini`](alembic.ini) ‚ú® –ù–û–í–´–ô
- [`run_migrations.py`](run_migrations.py) ‚ú® –ù–û–í–´–ô
- [`check_alembic.py`](check_alembic.py) ‚ú® –ù–û–í–´–ô
- [`apply_migrations_auto.py`](apply_migrations_auto.py) ‚ú® –ù–û–í–´–ô
- [`db/models.py`](db/models.py) - –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏ `Tariff`, `UserBalance`, `UserDiscount`

**DAL (Data Access Layer):**
- [`db/dal/tariff_dal.py`](db/dal/tariff_dal.py) ‚ú® –ù–û–í–´–ô
- [`db/dal/balance_dal.py`](db/dal/balance_dal.py) ‚ú® –ù–û–í–´–ô
- [`db/dal/discount_dal.py`](db/dal/discount_dal.py) ‚ú® –ù–û–í–´–ô
- [`db/dal/promo_code_dal.py`](db/dal/promo_code_dal.py) - —Ä–∞—Å—à–∏—Ä–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- [`db/dal/__init__.py`](db/dal/__init__.py) - –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã

**–°–µ—Ä–≤–∏—Å—ã:**
- [`bot/services/tariff_service.py`](bot/services/tariff_service.py) ‚ú® –ù–û–í–´–ô
- [`bot/services/balance_service.py`](bot/services/balance_service.py) ‚ú® –ù–û–í–´–ô
- [`bot/services/subscription_service.py`](bot/services/subscription_service.py) - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏
- [`bot/services/yookassa_service.py`](bot/services/yookassa_service.py) - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤

**Handlers (–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏) - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ:**
- [`bot/handlers/user/profile.py`](bot/handlers/user/profile.py) ‚ú® –ù–û–í–´–ô
- [`bot/handlers/user/balance_topup.py`](bot/handlers/user/balance_topup.py) ‚ú® –ù–û–í–´–ô
- [`bot/handlers/user/tariff_selection.py`](bot/handlers/user/tariff_selection.py) ‚ú® –ù–û–í–´–ô
- [`bot/handlers/user/payment.py`](bot/handlers/user/payment.py) - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏
- [`bot/handlers/user/subscription/payments.py`](bot/handlers/user/subscription/payments.py) - –æ–±–Ω–æ–≤–ª–µ–Ω

**Handlers (–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏) - –ê–¥–º–∏–Ω—Å–∫–∏–µ:**
- [`bot/handlers/admin/tariff_management.py`](bot/handlers/admin/tariff_management.py) ‚ú® –ù–û–í–´–ô
- [`bot/handlers/admin/discount_management.py`](bot/handlers/admin/discount_management.py) ‚ú® –ù–û–í–´–ô
- [`bot/handlers/admin/promo/create.py`](bot/handlers/admin/promo/create.py) - —Ä–∞—Å—à–∏—Ä–µ–Ω
- [`bot/handlers/admin/common.py`](bot/handlers/admin/common.py) - –æ–±–Ω–æ–≤–ª–µ–Ω

**States –∏ Keyboards:**
- [`bot/states/user_states.py`](bot/states/user_states.py) - –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- [`bot/states/admin_states.py`](bot/states/admin_states.py) - –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- [`bot/keyboards/inline/user_keyboards.py`](bot/keyboards/inline/user_keyboards.py) - –Ω–æ–≤—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
- [`bot/keyboards/inline/admin_keyboards.py`](bot/keyboards/inline/admin_keyboards.py) - –Ω–æ–≤—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

**–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è:**
- [`locales/ru.json`](locales/ru.json) - –¥–æ–±–∞–≤–ª–µ–Ω–æ ~150 –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–π
- [`locales/en.json`](locales/en.json) - –¥–æ–±–∞–≤–ª–µ–Ω–æ ~150 –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–π

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [`MIGRATION_GUIDE.md`](MIGRATION_GUIDE.md) ‚ú® –ù–û–í–´–ô
- [`db/migrations/README.md`](db/migrations/README.md) ‚ú® –ù–û–í–´–ô

---

### 1. –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### 1.1. –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**–§–∞–π–ª:** [`bot/handlers/user/profile.py`](bot/handlers/user/profile.py:1)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –º–æ–≥—É—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≤–æ–µ–º –ø—Ä–æ—Ñ–∏–ª–µ:
- üë§ –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (ID, –∏–º—è, username, –¥–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
- üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
- üìã –°—Ç–∞—Ç—É—Å –∏ –¥–µ—Ç–∞–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- üéÅ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–∫–∏–¥–∫–∏
- üí≥ –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–ª–∞–Ω—Å–æ–º

**–î–æ—Å—Ç—É–ø:** –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚Üí "üë§ –ü—Ä–æ—Ñ–∏–ª—å"

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
```python
async def build_profile_message()  # –§–æ—Ä–º–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
async def show_profile()            # –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def show_balance_history()    # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π
```

#### 1.2. –°–∏—Å—Ç–µ–º–∞ –±–∞–ª–∞–Ω—Å–∞
**–ú–æ–¥–µ–ª—å:** [`db/models.py:UserBalance`](db/models.py:300)
**–°–µ—Ä–≤–∏—Å:** [`bot/services/balance_service.py`](bot/services/balance_service.py:1)

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞:
- üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
- üí≥ –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–æ–∫ —Å –±–∞–ª–∞–Ω—Å–∞
- üìä –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- üîÑ –¢–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π: deposit, withdrawal, payment, refund, bonus

**–û–ø–µ—Ä–∞—Ü–∏–∏ –±–∞–ª–∞–Ω—Å–∞:**
```python
balance_service.deposit()         # –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
balance_service.charge()          # –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
balance_service.refund()          # –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
balance_service.add_bonus()       # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤
balance_service.record_payment()  # –ó–∞–ø–∏—Å—å –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏
```

**Handler:** [`bot/handlers/user/balance_topup.py`](bot/handlers/user/balance_topup.py:1)
- –í—ã–±–æ—Ä —Å—É–º–º—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –∏–ª–∏ —Å–≤–æ—è —Å—É–º–º–∞)
- –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã (YooKassa, CryptoPay, Stars –∏ –¥—Ä.)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã

#### 1.3. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã
**–ú–æ–¥–µ–ª—å:** [`db/models.py:Tariff`](db/models.py:61)
**–°–µ—Ä–≤–∏—Å:** [`bot/services/tariff_service.py`](bot/services/tariff_service.py:1)

–°–∏—Å—Ç–µ–º–∞ –≥–∏–±–∫–∏—Ö —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤:
- üì¶ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞—Ä–∏—Ñ–æ–≤
- ‚è± –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–∏)
- üíµ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
- üìä –õ–∏–º–∏—Ç—ã: —Ç—Ä–∞—Ñ–∏–∫, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Å–∫–æ—Ä–æ—Å—Ç—å
- ‚≠ê –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**–ê—Ç—Ä–∏–±—É—Ç—ã —Ç–∞—Ä–∏—Ñ–∞:**
```python
- name: str                          # –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞
- description: str                   # –û–ø–∏—Å–∞–Ω–∏–µ
- price: float                       # –¶–µ–Ω–∞
- currency: str                      # –í–∞–ª—é—Ç–∞ (RUB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- duration_days: int                 # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –¥–Ω—è—Ö
- traffic_limit_bytes: int | None    # –õ–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ (None = –±–µ–∑–ª–∏–º–∏—Ç)
- device_limit: int | None           # –õ–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (None = –±–µ–∑–ª–∏–º–∏—Ç)
- speed_limit_mbps: float | None     # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ (None = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
- is_active: bool                    # –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ç–∞—Ä–∏—Ñ
- is_default: bool                   # –¢–∞—Ä–∏—Ñ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

**Handler:** [`bot/handlers/user/tariff_selection.py`](bot/handlers/user/tariff_selection.py:1)
- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤ —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Ü–µ–Ω—ã —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–æ–∫
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–ø–ª–∞—Ç—ã —Å –±–∞–ª–∞–Ω—Å–∞ –∏–ª–∏ —á–µ—Ä–µ–∑ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∫ —Ç–∞—Ä–∏—Ñ–∞–º

#### 1.4. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** [`db/models.py:PromoCode`](db/models.py:179)
**Handler:** [`bot/handlers/admin/promo/create.py`](bot/handlers/admin/promo/create.py:1)

–¢—Ä–∏ —Ç–∏–ø–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:

**1. –ë–æ–Ω—É—Å–Ω—ã–µ –¥–Ω–∏ (`bonus_days`):**
- –î–æ–±–∞–≤–ª—è–µ—Ç –¥–Ω–∏ –∫ –ø–æ–¥–ø–∏—Å–∫–µ
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ü–µ–Ω—É
```python
type: 'bonus_days'
bonus_days: 7  # +7 –¥–Ω–µ–π –∫ –ø–æ–¥–ø–∏—Å–∫–µ
```

**2. –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è/—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞ (`discount`):**
- –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å–∫–∏–¥–∫–∞: `value <= 100` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20%)
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞: `value > 100` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 500 —Ä—É–±.)
```python
type: 'discount'
value: 20  # –°–∫–∏–¥–∫–∞ 20%
# –∏–ª–∏
value: 500  # –°–∫–∏–¥–∫–∞ 500 —Ä—É–±–ª–µ–π
```

**3. –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (`balance`):**
- –ù–∞—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ü–µ–Ω—É –ø–æ–¥–ø–∏—Å–∫–∏
```python
type: 'balance'
value: 100  # +100 —Ä—É–±–ª–µ–π –Ω–∞ –±–∞–ª–∞–Ω—Å
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:**
- `min_purchase_amount` - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
- `applicable_tariff_ids` - —Å–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤, –∫ –∫–æ—Ç–æ—Ä—ã–º –ø—Ä–∏–º–µ–Ω–∏–º –ø—Ä–æ–º–æ–∫–æ–¥
- `max_activations` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π
- `valid_until` - —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞

#### 1.5. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–∫–∏–¥–∫–∏
**–ú–æ–¥–µ–ª—å:** [`db/models.py:UserDiscount`](db/models.py:314)
**–°–µ—Ä–≤–∏—Å:** [`db/dal/discount_dal.py`](db/dal/discount_dal.py:1)

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å–∫–∏–¥–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:
- üéÅ –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (1-99%)
- üì¶ –ü—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å: –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ç–∞—Ä–∏—Ñ—É –∏–ª–∏ –∫–æ –≤—Å–µ–º
- üîÑ –ê–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∫–∏–¥–æ–∫
- üìä –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Å–∫–∏–¥–æ–∫

**–ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫–∏–¥–æ–∫:**
1. –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞
2. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. –ü—Ä–æ–º–æ–∫–æ–¥ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω)

**–ü—Ä–∏–º–µ—Ä:**
```
–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: 1000 —Ä—É–±.
–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ 20%: -200 —Ä—É–±. = 800 —Ä—É–±.
–ü—Ä–æ–º–æ–∫–æ–¥ 10%: -80 —Ä—É–±. = 720 —Ä—É–±.
–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: 720 —Ä—É–±.
```

---

### 2. –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

#### 2.1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏
**Handler:** [`bot/handlers/admin/tariff_management.py`](bot/handlers/admin/tariff_management.py:1)

–ü–æ–ª–Ω—ã–π CRUD —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è —Ç–∞—Ä–∏—Ñ–æ–≤:

**–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ (7 —à–∞–≥–æ–≤):**
1. –ù–∞–∑–≤–∞–Ω–∏–µ (3-50 —Å–∏–º–≤–æ–ª–æ–≤)
2. –û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. –¶–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö
4. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –¥–Ω—è—Ö (1-365)
5. –õ–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ –≤ GB (–∏–ª–∏ –±–µ–∑–ª–∏–º–∏—Ç)
6. –õ–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–∏–ª–∏ –±–µ–∑–ª–∏–º–∏—Ç)
7. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤ Mbps (–∏–ª–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏:**
- ‚úÖ –ê–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ç–∞—Ä–∏—Ñ–æ–≤
- ‚≠ê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞—Ä–∏—Ñ–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- üóë –£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤
- üìã –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–∞—Ä–∏—Ñ—É

**–°–æ—Å—Ç–æ—è–Ω–∏—è FSM:**
```python
AdminStates.waiting_for_tariff_name
AdminStates.waiting_for_tariff_description
AdminStates.waiting_for_tariff_price
AdminStates.waiting_for_tariff_duration
AdminStates.waiting_for_tariff_traffic_limit
AdminStates.waiting_for_tariff_device_limit
AdminStates.waiting_for_tariff_speed_limit
```

#### 2.2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∞–º–∏
**Handler:** [`bot/handlers/admin/discount_management.py`](bot/handlers/admin/discount_management.py:1)

–°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–∫–∏–¥–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∏–¥–∫–∏ (3 —à–∞–≥–∞):**
1. Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (1-99%)
3. –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏–ª–∏ –≤—Å–µ)

**–§—É–Ω–∫—Ü–∏–∏:**
- ‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–∫–∏–¥–æ–∫
- üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å–∫–∏–¥–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–π —Å–∫–∏–¥–∫–µ
- ‚ùå –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∫–∏–¥–æ–∫
- üîç –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–∞—Ä–∏—Ñ–∞

**–°–æ—Å—Ç–æ—è–Ω–∏—è FSM:**
```python
AdminStates.waiting_for_discount_user_id
AdminStates.waiting_for_discount_percentage
AdminStates.waiting_for_discount_tariff_selection
AdminStates.waiting_for_discount_view_user_id
```

#### 2.3. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
**Handler:** [`bot/handlers/admin/promo/create.py`](bot/handlers/admin/promo/create.py:1)

**–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (–¥–æ 7 —à–∞–≥–æ–≤):**
1. –ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (3-30 —Å–∏–º–≤–æ–ª–æ–≤)
2. –¢–∏–ø –ø—Ä–æ–º–æ–∫–æ–¥–∞ (bonus_days/discount/balance)
3. –ó–Ω–∞—á–µ–Ω–∏–µ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞)
4. –ü—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å –∫ —Ç–∞—Ä–∏—Ñ–∞–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
5. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
6. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π (1-10000)
7. –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–≤ –¥–Ω—è—Ö –∏–ª–∏ –±–µ—Å—Å—Ä–æ—á–Ω–æ)

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏:**
- üéü –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- üîÑ –ê–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è
- üìã –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–π
- üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
- üóë –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

**–ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM:**
```python
AdminStates.waiting_for_promo_type
AdminStates.waiting_for_promo_value
AdminStates.waiting_for_promo_tariffs
AdminStates.waiting_for_promo_min_purchase
```

---

### 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### 3.1. –ù–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**Tariff (–¢–∞—Ä–∏—Ñ—ã):**
```python
class Tariff(Base):
    id: int
    name: str
    description: str | None
    price: float
    currency: str = "RUB"
    duration_days: int
    traffic_limit_bytes: int | None
    device_limit: int | None
    speed_limit_mbps: float | None
    is_active: bool = True
    is_default: bool = False
```

**UserBalance (–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–ª–∞–Ω—Å–æ–º):**
```python
class UserBalance(Base):
    id: int
    user_id: int  # FK -> users.user_id
    amount: float
    currency: str = "RUB"
    operation_type: str  # deposit, withdrawal, payment, refund, bonus
    description: str | None
    created_at: datetime
```

**UserDiscount (–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–∫–∏–¥–∫–∏):**
```python
class UserDiscount(Base):
    id: int
    user_id: int  # FK -> users.user_id
    discount_percentage: float
    tariff_id: int | None  # FK -> tariffs.id (None = –≤—Å–µ —Ç–∞—Ä–∏—Ñ—ã)
    is_active: bool = True
    created_at: datetime
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ User:**
```python
class User(Base):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    balance: float = 0.0  # –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    # –ù–æ–≤—ã–µ relationships:
    balance_operations: List[UserBalance]
    discounts: List[UserDiscount]
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ Subscription:**
```python
class Subscription(Base):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    tariff_id: int | None  # FK -> tariffs.id
    tariff: Tariff  # relationship
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ Payment:**
```python
class Payment(Base):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    tariff_id: int | None  # FK -> tariffs.id
    tariff: Tariff  # relationship
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ PromoCode:**
```python
class PromoCode(Base):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    type: str  # 'bonus_days', 'discount', 'balance'
    value: float | None  # –ó–Ω–∞—á–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ –∏–ª–∏ –±–∞–ª–∞–Ω—Å–∞
    min_purchase_amount: float | None
    applicable_tariff_ids: List[int] | None  # JSON
```

#### 3.2. –ù–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã

**TariffService** ([`bot/services/tariff_service.py`](bot/services/tariff_service.py:1)):
```python
class TariffService:
    async def get_active_tariffs()
    async def get_tariff_by_id()
    async def calculate_final_price()  # –° —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Å–∫–∏–¥–æ–∫ –∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
    async def get_tariff_info()
    async def get_all_tariffs_info()
```

**BalanceService** ([`bot/services/balance_service.py`](bot/services/balance_service.py:1)):
```python
class BalanceService:
    async def get_balance()
    async def deposit()           # –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
    async def charge()            # –°–ø–∏—Å–∞–Ω–∏–µ
    async def refund()            # –í–æ–∑–≤—Ä–∞—Ç
    async def add_bonus()         # –ë–æ–Ω—É—Å
    async def record_payment()    # –ó–∞–ø–∏—Å—å –æ–ø–ª–∞—Ç—ã
    async def get_balance_history()
    
class InsufficientFundsError(Exception):
    """–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ"""
```

#### 3.3. –ù–æ–≤—ã–µ DAL –º–æ–¥—É–ª–∏

**TariffDAL** ([`db/dal/tariff_dal.py`](db/dal/tariff_dal.py:1)):
```python
async def create_tariff()
async def get_tariff_by_id()
async def get_active_tariffs()
async def get_all_tariffs()
async def update_tariff()
async def delete_tariff()
async def get_default_tariff()
```

**BalanceDAL** ([`db/dal/balance_dal.py`](db/dal/balance_dal.py:1)):
```python
async def add_balance_operation()
async def get_user_balance_history()
async def get_user_balance_count()
async def get_balance_total()
```

**DiscountDAL** ([`db/dal/discount_dal.py`](db/dal/discount_dal.py:1)):
```python
async def create_user_discount()
async def get_user_active_discounts()
async def get_all_user_discounts()
async def get_best_user_discount()  # –í—ã–±–∏—Ä–∞–µ—Ç –Ω–∞–∏–±–æ–ª—å—à—É—é —Å–∫–∏–¥–∫—É
async def deactivate_user_discount()
```

#### 3.4. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ handlers

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ:**
- [`bot/handlers/user/profile.py`](bot/handlers/user/profile.py:1) - –ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
- [`bot/handlers/user/balance_topup.py`](bot/handlers/user/balance_topup.py:1) - –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- [`bot/handlers/user/tariff_selection.py`](bot/handlers/user/tariff_selection.py:1) - –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–æ–≤
- [`bot/handlers/user/payment.py`](bot/handlers/user/payment.py:1) - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏
- [`bot/handlers/user/subscription/payments.py`](bot/handlers/user/subscription/payments.py:1) - –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Ç–∞—Ä–∏—Ñ–æ–≤

**–ê–¥–º–∏–Ω—Å–∫–∏–µ:**
- [`bot/handlers/admin/tariff_management.py`](bot/handlers/admin/tariff_management.py:1) - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏
- [`bot/handlers/admin/discount_management.py`](bot/handlers/admin/discount_management.py:1) - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∞–º–∏
- [`bot/handlers/admin/promo/create.py`](bot/handlers/admin/promo/create.py:1) - –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã

---

### 4. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

#### 4.1. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ [`requirements.txt`](requirements.txt:1) –µ—Å—Ç—å:
```txt
alembic>=1.13.0
sqlalchemy>=2.0.0
asyncpg>=0.29.0
```

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pip install -r requirements.txt
```

#### 4.2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
```bash
python apply_migrations_auto.py
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç**
```bash
python run_migrations.py
```

**–í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ Alembic –Ω–∞–ø—Ä—è–º—É—é**
```bash
alembic upgrade head
```

**–í Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:**
```bash
docker exec remnawave-tg-shop python apply_migrations_auto.py
# –∏–ª–∏
docker-compose exec remnawave-tg-shop alembic upgrade head
```

#### 4.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –ë–î:
```bash
alembic current
```

–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é:
```bash
alembic history --verbose
```

#### 4.4. –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π —Å–æ–∑–¥–∞–π—Ç–µ —Ç–∞—Ä–∏—Ñ—ã —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
2. –û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (—Ç–æ–ª—å–∫–æ –¥–ª—è `ADMIN_IDS`)
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: **üí∞ –¢–∞—Ä–∏—Ñ—ã –∏ —Ü–µ–Ω—ã** ‚Üí **üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏** ‚Üí **‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–∞—Ä–∏—Ñ**
4. –°–ª–µ–¥—É–π—Ç–µ –ø–æ—à–∞–≥–æ–≤–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞

**–ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞:**
- –ù–∞–∑–≤–∞–Ω–∏–µ: "–°—Ç–∞–Ω–¥–∞—Ä—Ç"
- –û–ø–∏—Å–∞–Ω–∏–µ: "–ë–∞–∑–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ –Ω–∞ –º–µ—Å—è—Ü"
- –¶–µ–Ω–∞: 299
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 30 –¥–Ω–µ–π
- –¢—Ä–∞—Ñ–∏–∫: –ë–µ–∑–ª–∏–º–∏—Ç (–≤–≤–µ–¥–∏—Ç–µ "-")
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: 3
- –°–∫–æ—Ä–æ—Å—Ç—å: –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–≤–≤–µ–¥–∏—Ç–µ "-")

#### 4.5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

–ù–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è **–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è**. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:
```env
# –í–∞–ª—é—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–∞—Ä–∏—Ñ–æ–≤
DEFAULT_CURRENCY=RUB

# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è/–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
MIN_BALANCE_TOPUP=100
MAX_BALANCE_TOPUP=10000
```

#### 4.6. –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)

–û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
alembic downgrade -1
```

–û—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
alembic downgrade base
```

---

### 5. –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

#### 5.1. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏

–í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º—ã** —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π:

‚úÖ **–ü–æ–¥–ø–∏—Å–∫–∏ –±–µ–∑ tariff_id:**
- –ü—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω–æ
- –ü–æ–ª–µ `tariff_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `subscriptions` –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (`nullable=True`)
- –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `duration_months`

‚úÖ **–ü–ª–∞—Ç–µ–∂–∏ –±–µ–∑ tariff_id:**
- –í—Å–µ —Å—Ç–∞—Ä—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- –ü–æ–ª–µ `tariff_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `payments` –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
- –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –Ω–µ –Ω–∞—Ä—É—à–µ–Ω–∞

‚úÖ **–ü—Ä–æ–º–æ–∫–æ–¥—ã:**
- –°—Ç–∞—Ä—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã —Ç–∏–ø–∞ `bonus_days` —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ù–æ–≤—ã–µ —Ç–∏–ø—ã (`discount`, `balance`) ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

#### 5.2. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–ú–∏–≥—Ä–∞—Ü–∏—è [`001_add_tariffs_balance_discounts.py`](db/migrations/versions/001_add_tariffs_balance_discounts.py:1) **—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ—Ç** –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –∫–æ–ª–æ–Ω–∫–∏, –Ω–µ –∏–∑–º–µ–Ω—è—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:

**–ß—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è:**
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `tariffs` (–ø—É—Å—Ç–∞—è)
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `user_balances` (–ø—É—Å—Ç–∞—è)
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `user_discounts` (–ø—É—Å—Ç–∞—è)
- ‚úÖ –ö–æ–ª–æ–Ω–∫–∞ `subscriptions.tariff_id` (NULL –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π)
- ‚úÖ –ö–æ–ª–æ–Ω–∫–∞ `payments.tariff_id` (NULL –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π)
- ‚úÖ –ö–æ–ª–æ–Ω–∫–∞ `users.balance` (0.0 –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

**–ß—Ç–æ –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç—Å—è:**
- ‚ùå –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏
- ‚ùå –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
- ‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ùå –ü—Ä–æ–º–æ–∫–æ–¥—ã

**–ü—Ä–æ—Ü–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–µ–Ω:**
```python
# –ü—Ä–∏–º–µ—Ä: —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
subscription = Subscription(
    user_id=12345,
    duration_months=1,
    tariff_id=None  # ‚Üê NULL, —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
)
```

#### 5.3. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç **–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ** –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É:

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã**
- –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∫–∞–∫ —Ä–∞–Ω—å—à–µ (–±–µ–∑ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞)
- –†–∞–±–æ—Ç–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏
- `tariff_id` –æ—Å—Ç–∞–µ—Ç—Å—è NULL

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã**
- –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞—Ä–∏—Ñ—ã —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—ã–±–∏—Ä–∞—é—Ç —Ç–∞—Ä–∏—Ñ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
- `tariff_id` –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –°–º–µ—à–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º**
- –°—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—Ç–∞—Ä—É—é —Å—Ö–µ–º—É
- –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî –Ω–æ–≤—ã–µ —Ç–∞—Ä–∏—Ñ—ã
- –û–±–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

---

### 6. –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ TODO

#### 6.1. –¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

‚ùó **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤:**
- –ü–æ–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω–∏–µ, –∞–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏–µ
- TODO: –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç–∞—Ä–∏—Ñ–∞

‚ùó **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–æ–∫:**
- –°–∫–∏–¥–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä—É—á–Ω–æ–π –æ–ø–ª–∞—Ç–µ
- TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–æ–∫

‚ùó **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º:**
- –ù–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ —Ç–∞—Ä–∏—Ñ–æ–≤
- TODO: –î–æ–±–∞–≤–∏—Ç—å –≤ –∞–¥–º–∏–Ω–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–¥–∞–∂ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º

‚ùó **–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–∫–∏–¥–æ–∫:**
- –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–∫–∏–¥–æ–∫
- TODO: –î–æ–±–∞–≤–∏—Ç—å audit log –¥–ª—è —Å–∫–∏–¥–æ–∫

#### 6.2. –ü–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ

üìã **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
- [ ] –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞—Ä–∏—Ñ–æ–≤
- [ ] –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤
- [ ] –ú–∞—Å—Å–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∏–¥–æ–∫ (–ø–æ –≥—Ä—É–ø–ø–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- [ ] –≠–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º
- [ ] –ü—Ä–æ–º–æ–∫–æ–¥—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫/–¥–Ω—è–º–Ω–µ–¥–µ–ª–∏

üìã **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
- [ ] –°–µ–∑–æ–Ω–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ü–µ–Ω
- [ ] –ü–∞–∫–µ—Ç—ã —Ç–∞—Ä–∏—Ñ–æ–≤ (bundling)
- [ ] –ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
- [ ] –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã –Ω–∞ –±–∞–ª–∞–Ω—Å
- [ ] –ö—ç—à–±—ç–∫ —Å–∏—Å—Ç–µ–º–∞

üìã **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤
- [ ] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM —Å–∏—Å—Ç–µ–º–∞–º–∏
- [ ] –ú—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω–æ—Å—Ç—å

---

### 7. –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### 7.1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ —á–µ—Ä–µ–∑ –∫–æ–¥

```python
from db.dal import tariff_dal
from sqlalchemy.ext.asyncio import AsyncSession

async def create_sample_tariff(session: AsyncSession):
    tariff_data = {
        "name": "–°—Ç–∞–Ω–¥–∞—Ä—Ç",
        "description": "–ë–∞–∑–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ –Ω–∞ –º–µ—Å—è—Ü",
        "price": 299.0,
        "currency": "RUB",
        "duration_days": 30,
        "traffic_limit_bytes": None,  # –ë–µ–∑–ª–∏–º–∏—Ç
        "device_limit": 3,
        "speed_limit_mbps": None,  # –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
        "is_active": True,
        "is_default": False
    }
    
    tariff = await tariff_dal.create_tariff(session, tariff_data)
    await session.commit()
    return tariff
```

#### 7.2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å–∫–∏–¥–∫–∏

```python
from db.dal import discount_dal

async def set_user_discount(session: AsyncSession, user_id: int):
    discount = await discount_dal.create_user_discount(
        session=session,
        user_id=user_id,
        discount_percentage=20.0,  # 20% —Å–∫–∏–¥–∫–∞
        tariff_id=None  # –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º —Ç–∞—Ä–∏—Ñ–∞–º
    )
    await session.commit()
    return discount
```

#### 7.3. –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
from bot.services.balance_service import BalanceService

async def topup_user_balance(
    session: AsyncSession,
    user_id: int,
    amount: float
):
    balance_service = BalanceService()
    
    operation = await balance_service.deposit(
        session=session,
        user_id=user_id,
        amount=amount,
        description="–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ YooKassa"
    )
    
    await session.commit()
    return operation
```

#### 7.4. –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–æ–∫

```python
from bot.services.tariff_service import TariffService

async def calculate_price(
    session: AsyncSession,
    user_id: int,
    tariff_id: int,
    promo_code: str = None
):
    tariff_service = TariffService()
    
    result = await tariff_service.calculate_final_price(
        session=session,
        user_id=user_id,
        tariff_id=tariff_id,
        promo_code=promo_code
    )
    
    print(f"–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: {result['base_price']} {result['currency']}")
    print(f"–°–∫–∏–¥–∫–∞: {result['discount_applied']} {result['currency']}")
    print(f"–ò—Ç–æ–≥–æ: {result['final_price']} {result['currency']}")
    
    return result
```

---

### 8. –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

üìö **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [`MIGRATION_GUIDE.md`](MIGRATION_GUIDE.md:1) - –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –º–∏–≥—Ä–∞—Ü–∏—è–º
- [`db/migrations/README.md`](db/migrations/README.md:1) - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ –º–∏–≥—Ä–∞—Ü–∏–π

üîó **–°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- –ú–æ–¥–µ–ª–∏: [`db/models.py`](db/models.py:1)
- –ú–∏–≥—Ä–∞—Ü–∏—è: [`db/migrations/versions/001_add_tariffs_balance_discounts.py`](db/migrations/versions/001_add_tariffs_balance_discounts.py:1)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: [`alembic.ini`](alembic.ini:1)

---

## üá¨üáß English Version

### Summary of Changes

A comprehensive tariff management system, user balance system, and personal discount system have been implemented. Full database migration infrastructure using Alembic has been added.

#### Main Features:
- ‚úÖ Multiple tariff management system
- ‚úÖ User balance system with transaction history
- ‚úÖ Personal user discounts
- ‚úÖ Extended promo code system (discounts, balance, bonus days)
- ‚úÖ User profile with detailed information
- ‚úÖ Balance top-up through payment systems
- ‚úÖ Admin panel for tariff management
- ‚úÖ Admin panel for discount management
- ‚úÖ Database migrations via Alembic

#### List of New and Modified Files:

**Migrations and Database:**
- [`db/migrations/versions/001_add_tariffs_balance_discounts.py`](db/migrations/versions/001_add_tariffs_balance_discounts.py) ‚ú® NEW
- [`db/migrations/env.py`](db/migrations/env.py) ‚ú® NEW
- [`db/migrations/script.py.mako`](db/migrations/script.py.mako) ‚ú® NEW
- [`alembic.ini`](alembic.ini) ‚ú® NEW
- [`run_migrations.py`](run_migrations.py) ‚ú® NEW
- [`check_alembic.py`](check_alembic.py) ‚ú® NEW
- [`apply_migrations_auto.py`](apply_migrations_auto.py) ‚ú® NEW
- [`db/models.py`](db/models.py) - added `Tariff`, `UserBalance`, `UserDiscount` models

**DAL (Data Access Layer):**
- [`db/dal/tariff_dal.py`](db/dal/tariff_dal.py) ‚ú® NEW
- [`db/dal/balance_dal.py`](db/dal/balance_dal.py) ‚ú® NEW
- [`db/dal/discount_dal.py`](db/dal/discount_dal.py) ‚ú® NEW
- [`db/dal/promo_code_dal.py`](db/dal/promo_code_dal.py) - extended functionality
- [`db/dal/__init__.py`](db/dal/__init__.py) - updated imports

**Services:**
- [`bot/services/tariff_service.py`](bot/services/tariff_service.py) ‚ú® NEW
- [`bot/services/balance_service.py`](bot/services/balance_service.py) ‚ú® NEW
- [`bot/services/subscription_service.py`](bot/services/subscription_service.py) - tariff integration
- [`bot/services/yookassa_service.py`](bot/services/yookassa_service.py) - tariff support

**Handlers - User:**
- [`bot/handlers/user/profile.py`](bot/handlers/user/profile.py) ‚ú® NEW
- [`bot/handlers/user/balance_topup.py`](bot/handlers/user/balance_topup.py) ‚ú® NEW
- [`bot/handlers/user/tariff_selection.py`](bot/handlers/user/tariff_selection.py) ‚ú® NEW
- [`bot/handlers/user/payment.py`](bot/handlers/user/payment.py) - tariff integration
- [`bot/handlers/user/subscription/payments.py`](bot/handlers/user/subscription/payments.py) - updated

**Handlers - Admin:**
- [`bot/handlers/admin/tariff_management.py`](bot/handlers/admin/tariff_management.py) ‚ú® NEW
- [`bot/handlers/admin/discount_management.py`](bot/handlers/admin/discount_management.py) ‚ú® NEW
- [`bot/handlers/admin/promo/create.py`](bot/handlers/admin/promo/create.py) - extended
- [`bot/handlers/admin/common.py`](bot/handlers/admin/common.py) - updated

**States and Keyboards:**
- [`bot/states/user_states.py`](bot/states/user_states.py) - new states added
- [`bot/states/admin_states.py`](bot/states/admin_states.py) - new states added
- [`bot/keyboards/inline/user_keyboards.py`](bot/keyboards/inline/user_keyboards.py) - new keyboards
- [`bot/keyboards/inline/admin_keyboards.py`](bot/keyboards/inline/admin_keyboards.py) - new keyboards

**Localization:**
- [`locales/ru.json`](locales/ru.json) - ~150 new keys added
- [`locales/en.json`](locales/en.json) - ~150 new keys added

**Documentation:**
- [`MIGRATION_GUIDE.md`](MIGRATION_GUIDE.md) ‚ú® NEW
- [`db/migrations/README.md`](db/migrations/README.md) ‚ú® NEW

---

### Deployment Instructions

#### 1. Install Dependencies

```bash
pip install -r requirements.txt
```

#### 2. Apply Database Migrations

**Option 1: Automatic (recommended)**
```bash
python apply_migrations_auto.py
```

**Option 2: Via script**
```bash
python run_migrations.py
```

**Option 3: Direct Alembic**
```bash
alembic upgrade head
```

**In Docker container:**
```bash
docker exec remnawave-tg-shop python apply_migrations_auto.py
```

#### 3. Create First Tariff

After applying migrations, create tariffs through the admin panel:
1. Launch the bot
2. Open admin panel (only for `ADMIN_IDS`)
3. Navigate: **üí∞ Tariffs and Pricing** ‚Üí **üìã Tariff Management** ‚Üí **‚ûï Create Tariff**
4. Follow the step-by-step tariff creation process

#### 4. Verify Migration

Check current DB version:
```bash
alembic current
```

View history:
```bash
alembic history --verbose
```

---

### Backward Compatibility

All existing subscriptions are **fully compatible** with the new system:

‚úÖ **Subscriptions without tariff_id:**
- Continue to work as before
- The `tariff_id` field is optional (`nullable=True`)
- Old logic still uses `duration_months`

‚úÖ **Payments without tariff_id:**
- All old payments are preserved
- The `tariff_id` field is optional
- Payment history is intact

‚úÖ **Promo codes:**
- Old `bonus_days` promo codes work without changes
- New types (`discount`, `balance`) are additional features

The migration **only adds** new tables and columns without modifying existing data.

---

### Contact and Support

üìö **Documentation:**
- [`MIGRATION_GUIDE.md`](MIGRATION_GUIDE.md:1) - Detailed migration instructions
- [`db/migrations/README.md`](db/migrations/README.md:1) - Migration system information

üîó **Related Files:**
- Models: [`db/models.py`](db/models.py:1)
- Migration: [`db/migrations/versions/001_add_tariffs_balance_discounts.py`](db/migrations/versions/001_add_tariffs_balance_discounts.py:1)
- Configuration: [`alembic.ini`](alembic.ini:1)

---

**Date:** November 23, 2024  
**Version:** 1.0.0  
**Migration:** 001_add_tariffs_balance_discounts