# SubscriptionService Refactoring Plan

## –ü—Ä–æ–±–ª–µ–º–∞

`SubscriptionService` –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π God Object anti-pattern:
- **1256 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞** –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
- **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** panel user management, subscription activation, billing, notifications
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** —Å–ª–æ–∂–Ω–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **–ü–ª–æ—Ö–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π —É—Å–ª–æ–∂–Ω—è–µ—Ç –∫–æ–¥
- **–ù–∞—Ä—É—à–µ–Ω–∏–µ SRP:** –æ–¥–∏–Ω –∫–ª–∞—Å—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É Single Responsibility:

### 1. SubscriptionCoreService
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø–æ–¥–ø–∏—Å–æ–∫

**–ú–µ—Ç–æ–¥—ã:**
- `activate_trial_subscription()` - –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–±–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
- `activate_subscription()` - –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–ª–∞—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
- `extend_subscription_days()` - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
- `delete_subscription()` - —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
- `get_active_subscription_details()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
- `get_all_user_subscriptions()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- `PanelApiService` - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–∞–Ω–µ–ª—å—é
- `Settings` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- DAL —Å–ª–æ–π - –¥–æ—Å—Ç—É–ø –∫ –ë–î

### 2. SubscriptionBillingService
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ë–∏–ª–ª–∏–Ω–≥ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ

**–ú–µ—Ç–æ–¥—ã:**
- `charge_subscription_renewal()` - —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
- `calculate_renewal_price()` - —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
- `process_auto_renewal()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è
- `get_billing_history()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- `YooKassaService` - –ø–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
- `UserBillingDAL` - –±–∏–ª–ª–∏–Ω–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
- `SubscriptionCoreService` - –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

### 3. SubscriptionNotificationService
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö

**–ú–µ—Ç–æ–¥—ã:**
- `get_subscriptions_ending_soon()` - –ø–æ–¥–ø–∏—Å–∫–∏ close to expiration
- `send_expiring_notification()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–∫–æ—Ä–æ–º –æ–∫–æ–Ω—á–∞–Ω–∏–∏
- `send_expired_notification()` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏
- `update_notification_timestamp()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- `Bot` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- `I18n` - –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
- `SubscriptionDAL` - –¥–æ—Å—Ç—É–ø –∫ –ø–æ–¥–ø–∏—Å–∫–∞–º

### 4. SubscriptionService (Facade)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∏ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

Facade pattern –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º.

**–ú–µ—Ç–æ–¥—ã:** –î–µ–ª–µ–≥–∏—Ä—É—é—Ç –≤—ã–∑–æ–≤—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–µ—Ä–≤–∏—Å–∞–º

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
bot/services/
‚îú‚îÄ‚îÄ subscription/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                      # –≠–∫—Å–ø–æ—Ä—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ core.py                          # SubscriptionCoreService
‚îÇ   ‚îú‚îÄ‚îÄ billing.py                       # SubscriptionBillingService
‚îÇ   ‚îú‚îÄ‚îÄ notifications.py                 # SubscriptionNotificationService
‚îÇ   ‚îî‚îÄ‚îÄ helpers.py                       # PanelUserHelper, ActivationHelper
‚îú‚îÄ‚îÄ subscription_service.py              # Facade (legacy compatibility)
```

## –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (1 –Ω–µ–¥–µ–ª—è)
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
2. ‚è≥ –°–æ–∑–¥–∞—Ç—å `bot/services/subscription/` –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
3. ‚è≥ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `SubscriptionCoreService`
4. ‚è≥ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `SubscriptionBillingService`
5. ‚è≥ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `SubscriptionNotificationService`
6. ‚è≥ –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ helper –∫–ª–∞—Å—Å—ã –≤ `helpers.py`

### –§–∞–∑–∞ 2: Refactor Facade (3 –¥–Ω—è)
1. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å `SubscriptionService` –¥–ª—è –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
2. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å deprecation warnings (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å dependency injection –≤ factories

### –§–∞–∑–∞ 3: Testing (3 –¥–Ω—è)
1. ‚è≥ Unit —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
2. ‚è≥ Integration —Ç–µ—Å—Ç—ã
3. ‚è≥ E2E —Ç–µ—Å—Ç—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–ª–æ—É

### –§–∞–∑–∞ 4: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (2 –¥–Ω—è)
1. ‚è≥ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
2. ‚è≥ Migration guide –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
3. ‚è≥ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞

### –§–∞–∑–∞ 5: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
1. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å handlers –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞–ø—Ä—è–º—É—é
2. ‚è≥ –£–¥–∞–ª–∏—Ç—å facade –∫–æ–≥–¥–∞ –≤—Å–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã
3. ‚è≥ Cleanup —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### –ö–æ–¥ –∫–∞—á–µ—Å—Ç–≤–æ
- ‚úÖ **Single Responsibility Principle:** –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω—É –æ–±–ª–∞—Å—Ç—å
- ‚úÖ **–õ–µ–≥—á–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:** –ú–µ–Ω—å—à–∏–µ, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- ‚úÖ **–õ—É—á—à–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å:** ~300-400 —Å—Ç—Ä–æ–∫ –Ω–∞ —Å–µ—Ä–≤–∏—Å –≤–º–µ—Å—Ç–æ 1256
- ‚úÖ **–ü—Ä–æ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å:** –ò–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞:** –†–∞–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ —Ä–∞–∑–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- ‚úÖ **–õ–µ–≥—á–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Ñ–∏—á–∏:** –ù–æ–≤—ã–µ —Ñ–∏—á–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å–µ—Ä–≤–∏—Å
- ‚úÖ **Microservices ready:** –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

### Performance
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:** –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ—â–µ –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–∞
- ‚úÖ **Async optimizations:** –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–°—Ç–∞—Ä—ã–π API —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Facade pattern:

```python
# –°—Ç–∞—Ä—ã–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
subscription_service = SubscriptionService(...)
result = await subscription_service.activate_subscription(...)

# –ù–æ–≤—ã–π –∫–æ–¥ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
core_service = SubscriptionCoreService(...)
result = await core_service.activate_subscription(...)
```

## –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

### –†–∏—Å–∫ 1: Breaking changes
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** Facade pattern –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

### –†–∏—Å–∫ 2: Performance regression
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** Benchmark —Ç–µ—Å—Ç—ã –¥–æ –∏ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### –†–∏—Å–∫ 3: Bugs –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** Comprehensive test coverage, –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

### –†–∏—Å–∫ 4: –°–ª–æ–∂–Ω–æ—Å—Ç—å DI
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** Update factories, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –Ω–∞ —Ñ–∞–π–ª: < 500
- ‚úÖ Cyclomatic complexity: < 10 per method
- ‚úÖ Test coverage: > 80%
- ‚úÖ Code duplication: < 5%
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: 100%

## Timeline

**Total: 3 –Ω–µ–¥–µ–ª–∏**
- Week 1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- Week 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- Week 3: Review, fixes, deployment

## –°—Ç–∞—Ç—É—Å

**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** üìù Planning - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ –±–∞–∑–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤  
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** Architecture Team  
**–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:** 2024-11-24  

---

**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–î–∞—Ç–∞:** 2024-11-24  
**–ê–≤—Ç–æ—Ä:** Kilo Code Architecture Team